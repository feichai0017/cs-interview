# 高可用高并发短链接系统设计方案（Short URL System Design）

## 一、需求澄清（Clarify Requirements）

在设计系统之前，需明确以下需求：

- 输入一个长链接，返回一个唯一的短链接（短 URL）
- 支持高并发写入和访问（如：几万 QPS）
- 短链接需尽可能短（如：6-8 字符）
- 短链接跳转需高可用、低延迟
- 支持链接设置过期时间（可选）
- 防止热门短链热点过载（如被刷）

## 二、系统架构总览

系统可拆为两个核心路径：

- **生成路径（写路径）**：长链 → 短链
- **访问路径（读路径）**：短链 → 长链 → 301 跳转

组件划分如下：

```
+----------+        +-------------+        +----------+       +------------+
| 客户端   | -----> | 网关/Nginx  | -----> | 应用服务 | --->  | Redis 缓存  |
+----------+        +-------------+        +----------+       +------------+
                                                             |
                                                             v
                                                       +-------------+
                                                       | MySQL/TiDB |
                                                       +-------------+
```

## 三、短链接生成方案

### 1. 自增 ID + Base62 编码

- 使用分布式 ID 生成器（如：Snowflake）生成唯一自增整数
- 使用 Base62 编码（A-Z, a-z, 0-9）转换为短字符串
- 控制生成长度在 6~8 位之间

### 2. 短链接 key 唯一性

- 生成后校验 key 是否存在
- 冲突时递增 ID 或使用前缀再生成一次

## 四、存储设计与跳转逻辑

### 1. 存储模型

- key: 短链字符串（如 ab12Cd）
- value: 长链接 URL、创建时间、过期时间

### 2. 存储策略

- 高频访问短链缓存在 Redis
- 持久化存储使用 MySQL / TiDB 等关系型数据库
- 定期清理过期短链（TTL + 后台任务）

### 3. 跳转路径

- 客户端访问短链：tinyurl.com/abc123
- 服务解析 key → 查 Redis
  - 若命中，直接跳转（HTTP 301）
  - 未命中则查数据库，回填缓存再跳转

## 五、分布式 ID 生成器设计

- 使用 Snowflake 算法，字段构成：
  - 41bit 时间戳 + 10bit 机器ID + 12bit 序列号
- 支持多节点部署，高并发生成唯一ID
- 可选 Redis INCR 实现简单 ID 发号器（需保证并发原子性）

## 六、系统高可用与热点应对

### 1. 高可用设计

- 服务层多副本部署，Nginx/ALB 负载均衡
- Redis 主从 + Sentinel/ProxyCluster
- 数据库主从 + 分库分表策略
- 消息队列异步处理日志、统计等非关键逻辑

### 2. 热点链接保护

- 提前预热缓存热点 key
- 设置 TTL+异步刷新策略
- 接入限流组件防止刷短链（如令牌桶）
- 热点监控 + 动态降级返回默认页

## 七、可扩展功能（附加能力）

- 同一长链接生成多个短链接（支持渠道追踪）
- 提供自定义短链码（如 /eric）
- 提供短链访问统计 API（PV、UV、跳转耗时）
- 使用 Kafka 异步投递访问日志，写入分析系统

## 八、总结语

> 短链接系统是一个读多写少、低延迟要求高的典型服务。
>
> 设计的关键在于：
> - 使用分布式ID生成唯一短链
> - 基于缓存+持久化存储实现高并发跳转
> - 加入缓存预热、限流与容灾机制提升系统稳定性

---

*以上设计适用于面试系统设计类题目，覆盖了生成、跳转、存储、高可用与热点控制等核心模块，可灵活扩展。*

